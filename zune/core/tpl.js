export default(async(t=null,e=null)=>{let l=t=>{let e=$(`[data-tpl="${t}"]:not(template) ?`);if(!e.length)return null;{let l=e.map(t=>t.$(":: ?").map(t=>({it:t,data:toBuild(t.dataset.set)||null}))),a=(t,e)=>({it:t,fields:e<l.length?l[e]:[]});return 1===e.length?a(e[0],0):e.map((t,e)=>a(t,e))}},a=()=>{let t=new Set,e={};for(let a in $("[data-tpl]:not(template) ?").map(a=>{let i=a.dataset.tpl.replace(/\s/g,"");if(!t.has(i)){let r=l(i);r&&(e[i]=r,t.add(i))}}),e)e.hasOwnProperty(a)&&isArr(e[a])&&(e[a]=e[a][0]||{});return hasObj(e)?e:null},i=(t,e=null)=>{if(!isElem(t))return null;let l=t.$("..{[data-tpl]}");if(!l)return null;let a=l.$(":: ?"),i=a.findIndex(e=>e.contains(t)),r={tpl:l,name:l.dataset.tpl.replace(/\s/g,""),field:-1!==i?a[i]:null,idx:i};return isFn(e)&&e(r),r},r=t=>t.length?t[0]:null,n=t=>t.length?1===t.length?t[0]:t:null,s=(t,e)=>t?e.filter(e=>e<t):[],d=(t,e)=>t?t.map((t,e)=>({val:t,idx:e})).filter(({val:t})=>Object.keys(e||[]).every(l=>isReg(e[l])?e[l].test(t.data[l]):toArr(e[l]).map(String).includes(String(t.data[l]).toLowerCase().trim()))).map(({idx:t})=>t):[],f=(t,e)=>(e=isNum(e)?[e]:e)&&hasArr(e)?s(t?t.length:0,e):d(t,e||[]),p=(t,e)=>{let l=[...t].filter((t,l)=>l!==e);return l[1]=isNum(l[1])?[l[1]]:l[1],l},u=(t,e=!1)=>{let l=$(`[data-tpl-alt="${t.it.dataset.tpl}"] ?`),a=e||hasArr(t.fields)?"true":"false",i=()=>{t.it.attr.toggle("inert","true"!==a),hasArr(l)&&l.attr.toggle("inert","true"===a)};coreData.duration?setTimeout(i,coreData.duration):i()},o={getTpl(t,e=!1){let a=l(t[0].replace(/\s/g,""));if(!a)return null;if(a=toArr(a),t.length>1){let s=!!(isElem(t[1])||hasArr(t[1])&&isElem(t[1][0]));s&&(t[1]=isElem(t[1])?[t[1]]:t[1],t[1].forEach((t,e,l)=>l[e]=l[e].$("..{[data-set]}")||i(l[e])?.field)),a.forEach(e=>{hasArr(e.fields)&&(e.fields=s?e.fields.filter(e=>t[1].includes(e.it)):f(e.fields,t[1]??[]).map(t=>e.fields[t]).filter(Boolean),e.fields=e.fields.length?e.fields:[])})}return e?n(a):r(a)},addTpl(t,e=!1){t=t.flatMap(t=>isArr(t)?t:[t]);let l=t[0].replace(/\s/g,""),a=$(`template[data-name="${l.split(":")[0]}"]`),i=$(`[data-tpl="${l}"]:not(template) ?`);if(!a||!hasArr(i))return null;let r=1===i.length?{it:i[0],fields:[]}:i.map(t=>({it:t,fields:[]}));if(!r)return null;r=toArr(r),t.shift();let s=t[t.length-1];(isStr(s)||isNum(s))&&t.pop(),"begin"===(s=isNum(s)?s<0?"end":s:isStr(s)&&["begin","end"].includes(s)?s:"end")&&(t=t.reverse()),t=hasArr(t)?t:[{}];let d=document.createElement("div");d.appendChild(a.content.cloneNode(!0)),1===d.$(":: ?").length&&(d=d.$("*"));let f="";t.forEach(t=>{t=isObj(t)?t:{};let e=d.cloneNode(!0);e.innerHTML=`<div>${e.innerHTML}</div>`.replace(/>([^<]+)</g,e=>e.replace(/\$\{([^}]+)\}/g,(e,l,a,i)=>a>0&&"\\"===i[a-1]?e:t.hasOwnProperty(l)?`<span data-set-txt-${l}>${t[l]}</span>`:"")).replace(/\\\$\{/g,"${").slice(5,-6);let l=e.$("?"),a=[];l.unshift(e),l.forEach(e=>{let l=e.attr.get();if(l){for(let i in l)if(l.hasOwnProperty(i)&&/\$\{.*\}/.test(l[i])){if("class"===i){let r=[];(l[i].split(" ").map(t=>t.trim())||[]).forEach(l=>{let a=l.match(/^\$\{(.*?)\}$/);a&&a[1]&&(r.includes(a[1])||r.push(a[1]),e.classList.remove(a[0]),t.hasOwnProperty(a[1])&&e.classList.add(t[a[1]]))}),e.setAttribute("data-set-cls",r.join(", "))}else if(!["data-set-attr","data-set-cls"].includes(i)){let n=l[i].match(/^\$\{(.*?)\}$/);if(n&&n[1]){let s=a.find(t=>t.it===e);s?s.data.push({name:n[1],attr:i}):a.push({it:e,data:[{name:n[1],attr:i}]})}}l[i].startsWith("\\${")&&e.setAttribute(i,`${l[i].slice(1)}`)}}}),a.length&&a.forEach(e=>{e.data?.length&&(e.data.forEach(({attr:l,name:a})=>e.it.setAttribute(l,t.hasOwnProperty(a)?isObj(t[a])?JSON.stringify(t[a]):t[a]:"")),e.it.setAttribute("data-set-attr",e.data.map(t=>`${String(t.name).replace(/"/g,"&quot;")}: '${(isObj(t.attr)?JSON.stringify(t.attr):String(t.attr)).replace(/"/g,"&quot;")}'`).join(", ")))}),e.dataset.set=Object.entries(t).map(([t,e])=>`${t}: '${(isObj(e)?JSON.stringify(e):String(e)).replace(/"/g,"&quot;")}'`).join(", "),f+=e.outerHTML});let p=[];return r.forEach(l=>{if(e&&(l.it.innerHTML=""),"end"===s)l.it.html(f,s);else{let a="begin"!==s?l.it.$(":: ?"):[],i="begin"===s?"begin":isNum(s)&&a.length>s?"before":"end";("before"===i?a[s]:l.it).html(f,i)}let r=l.it.$(":: ?"),n=t.length,d="begin"===s?r.slice(0,n):isNum(s)?r.slice(r.length<n+s?0:s,s+n):r.slice(-n);p.push(...d.map(t=>({it:t,data:toBuild(t.dataset.set)||null})))}),i.attr.toggle("inert",!1),$(`[data-tpl-alt="${l}"] ?`)?.attr.toggle("inert",!0),p.length&&init("tpl"),n(p)},replaceTpl:t=>o.addTpl(t,!0),setTpl(t){if(t.length<2||!isObj(t[1]))return null;let e=[];t[0]=t[0].replace(/\s/g,"");let a=l(t[0]);if(!a)return null;let r=!1;a=toArr(a);let n=!!(isElem(t[2])||hasArr(t[2])&&isElem(t[2][0]));n&&(t[2]=isElem(t[2])?[t[2]]:t[2],t[2].forEach((t,e,l)=>l[e]=l[e].$("..{[data-set]}")||i(l[e])?.field));let s=e=>{var l,a;for(let i in t[1]=(l=t[1],a=e.data,Object.fromEntries(Object.entries(l).map(([t,e])=>[t,e.replace(/\${(.*?)}/g,(t,e)=>a[e]??"")]))),t[1])t[1].hasOwnProperty(i)&&e.it.$(`span[data-set-txt-${i}] ?`).forEach(e=>{e.$("..{[data-tpl]}")?.dataset.tpl===t[0]&&(e.innerHTML=t[1][i])});return e.it.$("[data-set-cls] ?").forEach(l=>{if(l.$("..{[data-tpl]}")?.dataset.tpl===t[0]){let a=l.getAttribute("data-set-cls");a&&(a.split(",").map(t=>t.trim())||[]).forEach(a=>{t[1].hasOwnProperty(a)&&(e.data.hasOwnProperty(a)&&l.classList.remove(e.data[a]),l.classList.add(t[1][a]))})}}),e.it.$("[data-set-attr] ?").forEach(e=>{if(e.$("..{[data-tpl]}")?.dataset.tpl===t[0]){let l=e.getAttribute("data-set-attr");if(l&&isObj(l=toBuild(l)))for(let a in l)l.hasOwnProperty(a)&&t[1].hasOwnProperty(a)&&e.setAttribute(l[a],String(t[1][a]).replace(/"/g,"&quot;"))}}),e.data=Object.assign(e.data,t[1]),e.it.dataset.set=Object.entries(e.data).map(([t,e])=>`${t}: '${String(e).replace(/"/g,"&quot;")}'`).join(", "),e};return a.forEach(l=>{if(hasArr(l.fields)){let a=n?l.fields.filter(e=>t[2].includes(e.it)):f(l.fields,t[2]??[]).map(t=>l.fields[t]).filter(Boolean);a.forEach(t=>{t=s(t),r||e.push(t)})}r=!0}),e.length&&init("tpl"),e},removeTpl(t){let e=t[0].replace(/\s/g,"");if(!e)return null;if(1===t.length){let a=$(`[data-tpl="${e}"]:not(template) ?`);return a?.html(""),a?.attr.toggle("inert",!0),$(`[data-tpl-alt="${e}"] ?`)?.attr.toggle("inert",!1),{it:a[0],fields:[]}}if(isElem(t[1])||hasArr(t[1])&&isElem(t[1][0])){let n=[];t[1]=isElem(t[1])?[t[1]]:t[1],t[1].forEach(t=>{let e=t.$("..{[data-set]}")||i(t)?.field;e&&(coreData.duration?(e.attr.toggle("inert",!0),setTimeout(()=>e.remove(),coreData.duration)):e.remove(),n.push(e))});let s=l(e);return s?((s=toArr(s)).forEach(t=>{if(hasArr(t.fields))for(let e=t.fields.length-1;e>=0;e--)n.includes(t.fields[e].it)&&t.fields.splice(e,1);u(t,!1)}),r(s)):null}{let d=l(e);return d?((d=toArr(d)).forEach(e=>{if(hasArr(e.fields)){let l=f(e.fields,t[1]??[]);coreData.duration?l.forEach(t=>{if(e.fields[t]){let l=e.fields[t].it;l.attr.toggle("inert",!0),setTimeout(()=>l.remove(),coreData.duration),e.fields[t]=null}}):l.forEach(t=>{e.fields[t]&&(e.fields[t].it.remove(),e.fields[t]=null)}),e.fields=e.fields.filter(t=>hasObj(t)),e.fields=e.fields.length?e.fields:[]}u(e,!1)}),r(d)):null}},swapTpl(t){if(t.length<3)return null;if(isNum(t[1],t[2])){let e=$(`[data-tpl="${t[0]}"] :: ?`),l=e[t[1]],a=e[t[2]];return l&&a&&l!==a&&$.swap(l,a),[{it:l,data:toBuild(l?.dataset.set)||null},{it:a,data:toBuild(a?.dataset.set)||null}]}{let i=toArr(o.getTpl(p(t,2),!0)),r=toArr(o.getTpl(p(t,1),!0)),n=i.map(t=>t?.fields?.[0]||null),s=r.map(t=>t?.fields?.[0]||null),d=Math.min(n?.length,s?.length);n.length=s.length=d;let f=null;return n.forEach((t,e)=>{t?.it&&s[e]?.it&&t.it!==s[e].it&&($.swap(t.it,s[e].it),null===f&&(f=[t,s[e]]))}),f}},countTpl(t){if(t.length>1){let e=o.getTpl(t);return e?.fields?e.fields.length:0}{let l=$(`[data-tpl="${t[0]}"]:not(template)`);return isElem(l)?l.$(":: ?").length:0}},async componentTpl(t){if(t.length<=1)return null;let e=[...t];e.splice(1,1);let l=o.getTpl(e);if(!l)return null;l=toArr(l);let a={};await Promise.all(l.map(async e=>{if(hasArr(e.fields)){if(isObj(t[1]))for(let[l,i]of Object.entries(t[1])){let r=await component[l](e.fields,i);a[l]=r}else{let n=await component[t[1]](e.fields,null);a[t[1]]=n}}})),a.length&&init("tpl");let i=len(a);return i?1===i?Object.values(a)[0]:a:null}};return hasArr(e)?"pos"===t?i(...e):!!(e[0]&&o.hasOwnProperty(`${t}Tpl`))&&await o[`${t}Tpl`](e):"get"===t&&a()});